{% extends "base.html" %} {% block content %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/profilo_societa.css') }}">

<div class="societa-profile">
    <div class="societa-header">
        <div class="header-content">
            <!-- Society Logo/Initials -->
            <div class="profile-image">
                <div class="profile-initials">
                    {{ societa_name[:2].upper() }}
                </div>
            </div>

            <div class="header-text">
                <h1 class="societa-name">{{ societa_name }}</h1>
                {% if societa_data %}
                <div class="quick-stats">
                    {% if societa_data.codice %}
                    <span class="code-badge">{{ societa_data.codice }}</span>
                    {% endif %}
                    {% if societa_data.num_atleti %}
                    <span class="athletes-count">
                        <i class="fas fa-users"></i> {{ societa_data.num_atleti }} atleti
                    </span>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>

        {% if societa_data %}
        <div class="societa-details">
            <div class="detail-card">
                <i class="fas fa-trophy"></i>
                <div class="detail-content">
                    <label>Risultati totali</label>
                    <span class="detail-value">{{ societa_data.num_risultati or 'N/D' }}</span>
                </div>
            </div>

            <div class="detail-card">
                <i class="fas fa-external-link-alt"></i>
                <div class="detail-content">
                    <label>Profilo FIDAL</label>
                    {% if link_societa_fidal %}
                    <a href="{{ link_societa_fidal }}" target="_blank" class="detail-value">
                        Visualizza
                    </a>
                    {% else %}
                    <span class="detail-value">N/D</span>
                    {% endif %}
                </div>
            </div>

            <div class="detail-card">
                <i class="fas fa-calendar-alt"></i>
                <div class="detail-content">
                    <label>Stagione {{ current_year }}</label>
                    <span class="detail-value">{{ societa_data.num_risultati_stagione or 0 }} risultati</span>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Toggle buttons for sections -->
    <div class="section-toggle">
        <button id="show-seasonal-btn" class="toggle-btn active" data-section="seasonal">
            <span class="btn-text">Risultati Stagionali</span>
            <span class="btn-text-short">Stagione</span>
        </button>
        <button id="show-recent-btn" class="toggle-btn" data-section="recent">
            <span class="btn-text">Ultimi Risultati</span>
            <span class="btn-text-short">Recenti</span>
        </button>
        <button id="show-athletes-btn" class="toggle-btn" data-section="athletes">
            <span class="btn-text">Elenco Atleti</span>
            <span class="btn-text-short">Atleti</span>
        </button>
        <button id="show-records-btn" class="toggle-btn" data-section="records">
            <span class="btn-text">Record Società</span>
            <span class="btn-text-short">Record</span>
        </button>
    </div>

    <!-- Seasonal Results Section -->
    <section id="seasonal-section" class="results-section active">
        {% if not seasonal_results %}
        <p class="no-results">Nessun risultato stagionale disponibile per questa società.</p>
        {% else %}

        <!-- Season filter -->
        <div class="filter-bar">
            <label for="season-select">Stagione:</label>
            <select id="season-select" class="filter-select">
                {% for year in available_years %}
                <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>{{ year }}</option>
                {% endfor %}
            </select>
        </div>

                <div class="seasonal-list">
            {% for discipline_key, discipline_data in seasonal_results.items() %}
            <div class="seasonal-row gender-{{ discipline_data.gender }}" data-discipline="{{ discipline_key }}">
                <div class="seasonal-header" onclick="toggleSeasonalResults(this)">
                    <div class="discipline-name">
                        {{ discipline_data.base_discipline.replace('_',' ') }} 
                        <span class="gender-badge {{ discipline_data.gender }}">{{ discipline_data.gender }}</span>
                    </div>
                    <div class="result-count">
                        <span class="count-badge">{{ discipline_data.results|length }}</span>
                    </div>
                    <div class="best-result">
                        <span class="result"><b>{{ discipline_data.best.prestazione_display }}</b></span>
                        {% if discipline_data.best.vento %}
                        <span class="wind">({{ discipline_data.best.vento }})</span>
                        {% endif %}
                    </div>
                    <span class="toggle-icon">
                        <!-- SVG icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M6 9l6 6 6-6"/>
                        </svg>
                    </span>
                </div>
                
                <!-- Il resto della table rimane uguale, basta assicurarsi che i dati arrivino corretti -->
                <div class="details-container">
                    <table class="results-table sortable">
                        <thead>
                            <tr>
                                <th class="sortable-header sort-default" data-sort="result">Pres. <span class="sort-icon">▼</span></th>
                                <th>Atleta</th>
                                <th class="sortable-header" data-sort="date">Data <span class="sort-icon"></span></th>
                                <th>Luogo</th>
                                <th>Cat.</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for result in discipline_data.results %}
                            <tr data-raw-result="{{ result.prestazione if result.prestazione is not none else 0 }}"
                                data-raw-date="{{ result.data.strftime('%Y%m%d') if result.data else '00000000' }}">
                                <td class="result">
                                    {{ result.prestazione_display }}
                                    {% if result.vento %}
                                    <span class="wind"> ({{ result.vento }})</span>
                                    {% endif %}
                                </td>
                                <td class="athlete-name">
                                    <a href="{{ url_for('atleti.atleta_profilo', atleta_path=result.atleta_link) }}">
                                        {{ result.atleta }}
                                    </a>
                                </td>
                                <td class="date">{{ result.data.strftime('%d/%m/%Y') if result.data else '-' }}</td>
                                <td class="location">{{ result.luogo or '-' }}</td>
                                <td class="category">{{ result.categoria or '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </section>

    <!-- Recent Results Section -->
    <section id="recent-section" class="results-section">
        {% if not recent_results %}
        <p class="no-results">Nessun risultato recente disponibile.</p>
        {% else %}
        <table class="recent-results-table">
            <tbody>
                {% set ns = namespace(last_group=None) %}
                {% for result in recent_results %}
                {% set current_group = result.data.strftime('%d/%m/%Y') ~ ' - ' ~ result.luogo %}
                {% if current_group != ns.last_group %}
                <tr class="group-header">
                    <td colspan="4">{{ current_group }}</td>
                </tr>
                {% set ns.last_group = current_group %}
                {% endif %}
                <tr class="result-row">
                    <td class="discipline">{{ result.disciplina.replace('_', ' ') }}</td>
                    <td class="athlete-name">
                        <a href="{{ url_for('atleti.atleta_profilo', atleta_path=result.atleta_link) }}">
                            {{ result.atleta }}
                        </a>
                    </td>
                    <td class="result">
                        {{ result.prestazione_display }}
                        {% if result.vento %}
                        <span class="wind"> ({{ result.vento }})</span>
                        {% endif %}
                    </td>
                    <td class="position">{{ result.posizione or '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </section>

    <!-- Athletes List Section -->
    <section id="athletes-section" class="results-section">
        {% if not athletes %}
        <p class="no-results">Nessun atleta trovato per questa società.</p>
        {% else %}

        <!-- Search and filters -->
        <div class="filter-bar">
            <input type="text" id="athlete-search" class="filter-input" placeholder="Cerca atleta...">
            <select id="gender-filter" class="filter-select">
                <option value="">Tutti</option>
                <option value="M">Uomini</option>
                <option value="F">Donne</option>
            </select>
            <select id="status-filter" class="filter-select">
                <option value="">Tutti gli atleti</option>
                <option value="active">Attivi ({{ current_year }})</option>
                <option value="historical">Solo storici</option>
            </select>
            <select id="category-filter" class="filter-select">
                <option value="">Tutte le categorie</option>
                {% for cat in athlete_categories %}
                <option value="{{ cat }}">{{ cat }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Athletes count indicator -->
        <div class="athletes-count-indicator">
            <span id="visible-athletes-count">{{ athletes|length }}</span> / {{ athletes|length }} atleti
        </div>

        <div class="athletes-grid">
            {% for athlete in athletes %}
            <div class="athlete-card" 
                data-name="{{ athlete.nome|lower }}" 
                data-category="{{ athlete.categoria }}"
                data-gender="{{ athlete.genere }}"
                data-active="{{ 'true' if athlete.is_active else 'false' }}">
                <a href="{{ url_for('atleti.atleta_profilo', atleta_path=athlete.link) }}" class="athlete-link">
                    <div class="athlete-avatar {% if athlete.genere == 'F' %}female{% endif %}">
                        {{ athlete.nome[:2].upper() }}
                    </div>
                    <div class="athlete-info">
                        <span class="athlete-name">{{ athlete.nome }}</span>
                        <span class="athlete-meta">
                            {% if athlete.anno %}({{ athlete.anno }}){% endif %}
                            {% if athlete.categoria %}
                            <span class="category-tag">{{ athlete.categoria }}</span>
                            {% endif %}
                        </span>
                    </div>
                    <div class="athlete-stats">
                        <span class="stat">{{ athlete.num_risultati }} ris.</span>
                        {% if athlete.is_active %}
                        <span class="active-badge" title="Attivo {{ current_year }}">●</span>
                        {% endif %}
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </section>

    <!-- Society Records Section -->
    <section id="records-section" class="results-section">
        {% if not records %}
        <p class="no-results">Nessun record disponibile per questa società.</p>
        {% else %}

        <!-- Discipline type filter -->
        <div class="filter-bar">
            <select id="discipline-type-filter" class="filter-select">
                <option value="">Tutte le discipline</option>
                <option value="Corse Piane">Corse Piane</option>
                <option value="Ostacoli">Ostacoli</option>
                <option value="Salti">Salti</option>
                <option value="Lanci">Lanci</option>
                <option value="Marcia">Marcia</option>
                <option value="Siepi">Siepi</option>
                <option value="Prove Multiple">Prove Multiple</option>
            </select>
        </div>

                <div class="records-list">
            {% for discipline_key, record in records.items() %}
            <div class="record-row gender-{{ record.gender }}" data-discipline="{{ discipline_key }}" data-type="{{ record.tipo }}">
                <div class="record-header" onclick="toggleRecordDetails(this)">
                    <div class="discipline-name">
                        {{ record.base_discipline.replace('_',' ') }}
                        <span class="gender-badge {{ record.gender }}">{{ record.gender }}</span>
                    </div>
                    <div class="record-result">
                        <span class="result"><b>{{ record.best.prestazione_display }}</b></span>
                        {% if record.best.vento %}
                        <span class="wind">({{ record.best.vento }})</span>
                        {% endif %}
                    </div>
                    <div class="record-holder">
                        <a href="{{ url_for('atleti.atleta_profilo', atleta_path=record.best.atleta_link) }}">
                            {{ record.best.atleta }}
                        </a>
                    </div>
                    <div class="record-details">
                        <span class="date">{{ record.best.data.strftime('%d/%m/%Y') if record.best.data else '-' }}</span>
                    </div>
                    <span class="toggle-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M6 9l6 6 6-6"/>
                        </svg>
                    </span>
                </div>

                <div class="details-container">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Prestazione</th>
                                <th>Atleta</th>
                                <th>Data</th>
                                <th>Luogo</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for i, result in enumerate(record.top_10) %}
                            <tr>
                                <td class="rank">{{ i + 1 }}</td>
                                <td class="result">
                                    {{ result.prestazione_display }}
                                    {% if result.vento %}
                                    <span class="wind"> ({{ result.vento }})</span>
                                    {% endif %}
                                </td>
                                <td class="athlete-name">
                                    <a href="{{ url_for('atleti.atleta_profilo', atleta_path=result.atleta_link) }}">
                                        {{ result.atleta }}
                                    </a>
                                </td>
                                <td class="date">{{ result.data.strftime('%d/%m/%Y') if result.data else '-' }}</td>
                                <td class="location">{{ result.luogo or '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </section>

</div>

<!-- Include JavaScript -->
<script src="{{ url_for('static', filename='js/profilo_societa.js') }}"></script>

{% endblock %}
