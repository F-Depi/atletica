{% extends "base.html" %}
{% block content %}
<div id="disciplineInfo" 
    data-discipline="{{ discipline }}"
    data-classifica-type="{{ discipline_info.classifica }}"
    style="display: none;">
</div>

<div id="filtersContainer" class="filters">
    <!-- Tab selector -->
    <div class="tabs">
        <button class="tab-btn" data-tab="men">Uomini</button>
        <button class="tab-btn" data-tab="women">Donne</button>
        <button class="tab-btn" data-tab="advanced">Tutti i filtri e le gare</button>
    </div>

    <!-- Men tab content -->
    <div id="menTab" class="tab-content">
        <form id="menForm" class="filter-form">
            <select name="category" class="filter-select" id="menCategorySelect">
                <option value="ASS">Assoluti</option>
                <option value="SEN">Senior</option>
                <option value="U23">Promesse</option>
                <option value="U20">Juniores</option>
                <option value="U18">Allievi</option>
                <option value="U16">Cadetti</option>
                <option value="U14">Ragazzi</option>
                <option value="U12">Esordienti</option>
            </select>

            <select name="discipline" class="filter-select" id="menDisciplineSelect" disabled>
                <option value="">Disciplina</option>
            </select>

            <select name="year" class="filter-select" id="menYearSelect">
                <option value="">Tutti gli anni</option>
                {% for y in range(2025, 2004, -1) %}
                <option value="{{ y }}">{{ y }}</option>
                {% endfor %}
            </select>

            <select name="limit" class="filter-select" id="menLimitSelect">
                <option value="50">50 risultati</option>
                <option value="100">100 risultati</option>
                <option value="200">200 risultati</option>
                <option value="500">500 risultati</option>
            </select>

            <label class="toggle-switch">
                <input type="checkbox" name="allResults" value="true" {% if show_all %}checked{% endif %} id="menAllResults" {% if show_all %}checked{% endif %}>
                <span class="toggle-slider"></span>
                <span class="toggle-label">Tutti i risultati</span>
            </label>

            <div id="menWindCheckbox" class="wind-checkbox" style="display: none;">
                <label>
                    <input type="checkbox" name="legal_wind" checked>
                    Escludi ventosi
                </label>
            </div>

            <button type="submit" class="apply-filters-btn">Applica filtri</button>
        </form>
    </div>


    <!-- Women tab content (stessa struttura ma con ID diversi) -->
    <div id="womenTab" class="tab-content">
        <form id="womenForm" class="filter-form">
            <select name="category" class="filter-select" id="womenCategorySelect">
                <option value="ASS">Assolute</option>
                <option value="SEN">Senior</option>
                <option value="U23">Promesse</option>
                <option value="U20">Juniores</option>
                <option value="U18">Allieve</option>
                <option value="U16">Cadette</option>
                <option value="U14">Ragazze</option>
                <option value="U12">Esordienti</option>
            </select>

            <select name="discipline" class="filter-select" id="womenDisciplineSelect" disabled>
                <option value="">Disciplina</option>
            </select>

            <select name="year" class="filter-select" id="womenYearSelect">
                <option value="">Tutti gli anni</option>
                {% for y in range(2025, 2004, -1) %}
                <option value="{{ y }}">{{ y }}</option>
                {% endfor %}
            </select>

            <select name="limit" class="filter-select" id="womenLimitSelect">
                <option value="50">50 risultati</option>
                <option value="100">100 risultati</option>
                <option value="200">200 risultati</option>
                <option value="500">500 risultati</option>
            </select>

            <label class="toggle-switch">
                <input type="checkbox" name="allResults" value="true" {% if show_all %}checked{% endif %} id="womenAllResults">
                <span class="toggle-slider"></span>
                <span class="toggle-label">Tutti i risultati</span>
            </label>

            <div id="womenWindCheckbox" class="wind-checkbox" style="display: none;">
                <label>
                    <input type="checkbox" name="legal_wind" checked>
                    Escludi ventosi
                </label>
            </div>

            <button type="submit" class="apply-filters-btn">Applica filtri</button>
        </form>
    </div>


    <!-- Advanced tab content -->
    <div id="advancedTab" class="tab-content">
        <form id="advancedForm" class='filter-form'>
            <!-- Discipline filter -->
            <select name="discipline" class="filter-select" id="advancedDisciplineSelect">
                <option value="">Disciplina</option>
            </select>

            <!-- Indoor/Outdoor filter -->
            <select name="ambiente" class="filter-select">
                <option value="ALL" {% if ambiente == 'ALL' %}selected{% endif %}>Tutti (I/O)</option>
                <option value="I" {% if ambiente == 'I' %}selected{% endif %}>Indoor</option>
                <option value="P" {% if ambiente == 'P' %}selected{% endif %}>Outdoor</option>
            </select>

            <!-- Year filter -->
            <select name="year" class="filter-select">
                <option value="">Tutti gli anni</option>
                {% for y in range(2025, 2004, -1) %}
                <option value="{{ y }}" {% if year == y|string %}selected{% endif %}>{{ y }}</option>
                {% endfor %}
            </select>

            <!-- Gender filter -->
            <select name="gender" class="filter-select">
                <option value="">Misto</option>
                <option value="M" {% if gender == 'M' %}selected{% endif %}>Uomini</option>
                <option value="F" {% if gender == 'F' %}selected{% endif %}>Donne</option>
            </select>

            <!-- Category filter -->
            <select name="category" class="filter-select">
                <option value="">Tutte le categorie</option>
                <option value="U14">Ragazzi</option>
                <option value="U16">Cadetti</option>
                <option value="U18">Allievi</option>
                <option value="U20">Juniores</option>
                <option value="U23">Promesse</option>
                <option value="SEN">Senior</option>
                <option value="ASS">Assoluti</option>
                <!-- Master from 35 to 85 -->
                {% for i in range(35, 100, 5) %}
                <option value="M{{ i }}" {% if category == 'M' + i|string %}selected{% endif %}>Master {{ i }}</option>
                {% endfor %}
            </select>

            <!-- Limit filter -->
            <select name="limit" class="filter-select">
                <option value="50" {% if limit == 50 %}selected{% endif %}>50 risultati</option>
                <option value="100" {% if limit == 100 %}selected{% endif %}>100 risultati</option>
                <option value="200" {% if limit == 200 %}selected{% endif %}>200 risultati</option>
                <option value="500" {% if limit == 500 %}selected{% endif %}>500 risultati</option>
            </select>

            <label class="toggle-switch">
                <input type="checkbox" name="allResults" value="true" {% if show_all %}checked{% endif %}>
                <span class="toggle-slider"></span>
                <span class="toggle-label">Tutti i risultati</span>
            </label>

            <div id="windCheckbox" class="wind-checkbox" style="display: none;">
                <label>
                    <input type="checkbox" name="legal_wind" checked>
                    Escludi ventosi
                </label>
            </div>

            <button type="submit" class="apply-filters-btn">Applica filtri</button>
        </form>
    </div>
</div>


<div class="stats-container" id="statsContainer">
    <!-- Stats will be loaded here -->
</div>

<div class="rankings-table-container">
    <table class="rankings-table">
        <thead>
            <tr>
                <th></th>
                <th>Risultato</th>
                {% if show_wind %}
                <th>Vento</th>
                {% endif %}
                {% if ambiente == "ALL" and not show_wind%}
                <th>Ambiente</th>
                {% endif %}
                <th>Atleta</th>
                <th>Anno</th>
                <th>Categoria</th>
                <th>Società</th>
                <th>Luogo</th>
                <th>Data</th>
            </tr>
        </thead>
        <tbody>
            {% for result in results %}
            <tr>
                <td><b>{{ result.position }}</b></td>
                <td>{{ format_time(result.prestazione, discipline_info, result.cronometraggio) }}</td>
                {% if show_wind %}
                <td>{{ result.vento if result.ambiente == 'P' else '(Indoor)' }}</td>
                {% endif %}
                {% if ambiente == "ALL" and not show_wind %}
                <td>{{ 'Indoor' if result.ambiente == 'I' else 'Outdoor' }}</td>
                {% endif %}
                <td><a href="{{ result.link_atleta }}">{{ result.atleta }}</a></td>
                <td>{{ result.anno }}</td>
                <td>{{ result.categoria }}</td>
                <td><a href="{{ result.link_società }}">{{ result.società }}</a></td>
                <td>{{ result.luogo }}</td>
                <td>{{ result.data.strftime('%d/%m/%Y') if result.data else '' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>


<!-- Pagination section in rankings.html -->
<div class="pagination" data-total-pages="{{ total_pages }}" data-current-tab="{{ request.args.get('tab', 'men') }}">
    {% if total_pages > 1 %}
        {% set start = [1, current_page - 2] | max %}
        {% set end = [total_pages, current_page + 2] | min %}

        <!-- Crea una funzione per generare l'URL con tutti i parametri -->
        {% macro pagination_url(page_num) %}
            {% set params = request.args.copy() %}
            {% set _ = params.update({'page': page_num}) %}
            {{ url_for('rankings', **params) }}
        {% endmacro %}

        {% if start > 1 %}
            <a href="{{ pagination_url(1) }}" class="page-link">1</a>
            {% if start > 2 %}
                <span class="page-ellipsis">...</span>
            {% endif %}
        {% endif %}

        {% for p in range(start, end + 1) %}
            <a href="{{ pagination_url(p) }}" class="page-link {% if p == current_page %}active{% endif %}">{{ p }}</a>
        {% endfor %}

        {% if end < total_pages %}
            {% if end < total_pages - 1 %}
                <span class="page-ellipsis">...</span>
            {% endif %}
            <a href="{{ pagination_url(total_pages) }}" class="page-link">{{ total_pages }}</a>
        {% endif %}

        <div class="page-input-container">
            <input type="number" id="pageInput" min="1" max="{{ total_pages }}" class="page-input" placeholder="Pagina">
            <button onclick="goToPage()" class="page-go-btn">Vai</button>
        </div>
    {% endif %}
</div>


<!-- Include the external JavaScript file -->
<script src="{{ url_for('static', filename='js/rankings.js') }}"></script>

{% endblock %}
